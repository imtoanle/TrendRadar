name: Hot News Crawler

on:
  schedule:
    # We use GitHub's official resources for push notifications, and each account has limited resources. To avoid being flagged as abuse and facing account suspension, it's not recommended to run more frequently than every 30 minutes
    - cron: "0 * * * *" # Run once every hour at the top of the hour (with actual deviation) or "*/30 * * * *" (run every 30 minutes) or "*/30 0-14 * * *" (run every 30 minutes from 8 AM to 10 PM daily)
  workflow_dispatch:

# Add permission settings
permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify required files
        run: |
          echo "üîç Checking required configuration files..."

          if [ ! -f config/config.yaml ]; then
            echo "‚ùå Error: config/config.yaml file does not exist"
            echo "Please refer to the project documentation to create the configuration file"
            exit 1
          fi

          if [ ! -f config/frequency_words.txt ]; then
            echo "‚ùå Error: config/frequency_words.txt file does not exist"
            echo "Please refer to the project documentation to create the frequency words configuration file"
            exit 1
          fi

          echo "‚úÖ Configuration files check passed"

      - name: Run crawler
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          WEWORK_MSG_TYPE: ${{ secrets.WEWORK_MSG_TYPE }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          NTFY_SERVER_URL: ${{ secrets.NTFY_SERVER_URL }}
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
          GITHUB_ACTIONS: true
        run: python main.py

      - name: Commit and push if changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add -A
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update by GitHub Actions at $(TZ=Asia/Shanghai date)" && git push)
